{% extends 'layouts/default/page.html' %}

{% block extra_style %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 56px); /* Subtract navbar height */
        overflow: hidden;
    }

    /* Clients List */
    .clients-sidebar {
        width: 300px;
        min-width: 300px;
        border-right: 1px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        background: #f8f9fa;
        height: calc(100vh - 75px)
    }

    .clients-header {
        padding: 20px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
        font-size: 18px;
        font-weight: 600;
    }

    .clients-list {
        flex: 1;
        overflow-y: auto;
        min-height: 0;
    }

    .clients-list a {
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .client-item {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        cursor: pointer;
        transition: background 0.2s;
        background: #fff;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .client-item:hover {
        background: #f0f0f0;
    }

    .client-item.active {
        background: #e3f2fd;
        border-left: 3px solid #2196F3;
    }

    .client-item.has-unread {
        font-weight: 600;
    }

    .client-name {
        flex: 1;
    }

    .unread-badge {
        background: #2196F3;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 12px;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
    }

    /* Chat Area */
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
    }

    .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #999;
        font-size: 16px;
    }

    @keyframes highlight {
        0%, 100% { background: transparent; }
        50% { background: #ffeb3b; }
    }

    .hidden {
        display: none;
    }

    .container-fluid {
        padding: 0;
        margin: 0;
        max-width: 100%;
    }
</style>

{% block chat_extra_style %}
{% endblock chat_extra_style %}

{% endblock extra_style %}


{% block content %}
<div class="chat-container">
    <!-- Clients Sidebar -->
    <div class="clients-sidebar">
        <div class="clients-header">Clients</div>
        <div class="clients-list" id="clientsList">
            {% for client in clients %}
            <a href="#" onclick="selectClient(event, '{% url 'chat:chat_with_client' client.id %}')">
                <div class="client-item {% if client.unread_count > 0 %}has-unread{% endif %} {% if selected_client and client.id == selected_client.id %}active{% endif %}">
                    <span class="client-name">{{client.name|escape}}</span>
                    {% if client.unread_count > 0 %}<span class="unread-badge">{{ client.unread_count }}</span>{% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
        {% block chat_with_client %}
        <div id="emptyState" class="empty-state">
            Выберете клиента из списка
        </div>
        {% endblock chat_with_client %}
    </div>
</div>

<script>
    let ws = null
    let web_socket_queue = []

    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
    });

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:'
        ws = new WebSocket(`${protocol}//${window.location.host}/ws/chat/`)
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            console.log("message from server: " + event.data);
            if (data.type === 'new_message') {
                handleNewMessage(data.message);
            }
            else if (data.type === 'edit_message') {
                handleEditMessage(data.message);
            }
        }
        ws.onopen = () => {
            while (typeof (item = web_socket_queue.shift()) !== "undefined") {
                ws.send(item);
            }
        }
        ws.onerror = (event) => {
            console.log('WebSocket error: ' + event);
        }
        ws.onclose = (event) => {
            console.log('WebSocket disconnected. Reconnecting...');
            console.log(event);
            setTimeout(() => connectWebSocket(), 3000);
        }
    }

    function selectClient(e, chatWithClientUrl) {
        e.preventDefault();
        window.location.href = chatWithClientUrl;
    }

    function mark_read(client_id) {
        sendToWS({
            action: 'mark_read',
            client_id: client_id
        });
    }

    function sendToWS(message) {
        try {
            stringified = JSON.stringify(message);
            if (ws && ws.readyState == WebSocket.OPEN) {
                ws.send(stringified);
            } else {
                web_socket_queue.push(stringified)
            }
            return true;
        } catch (error) {
            console.error("Error sending message: ", error);
            return false;
        }
    }
</script>

{% block chat_extra_js %}
{% endblock chat_extra_js %}

{% endblock content %}
