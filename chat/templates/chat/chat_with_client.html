{% extends 'chat/base.html' %}

{% block chat_extra_style %}
<style>
    {% include 'chat/chat_with_client.css' %}
</style>
{% endblock chat_extra_style %}

{% block chat_with_client %}
<div id="chatContent">
    <div class="chat-header" id="chatHeader">{{ selected_client.name }}</div>

    <div class="chat-messages" id="messagesContainer">
        <!-- Здесь будут отображаться сообщение. Элементы для каждого сообщения создаются через createMessageElement() -->
    </div>

    <div class="message-input-area">
        <div class="reply-indicator" id="replyIndicator">
            <span class="reply-text" id="replyText"></span>
            <button class="cancel-reply" onclick="cancelReply()">Cancel</button>
        </div>

        <div class="edit-indicator" id="editIndicator">
            <span class="edit-text" id="editText">Editing message</span>
            <button class="cancel-edit" onclick="cancelEdit()">Cancel</button>
        </div>

        <div class="input-wrapper">
                    <textarea
                            id="messageInput"
                            class="message-input"
                            placeholder="Type a message..."
                            rows="3"
                    ></textarea>
            <button class="send-button" id="sendButton" onclick="sendMessage()">
                Send
            </button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div id="contextMenu" class="context-menu">
    <div class="context-menu-item" id="replyMenuItem" onclick="replayMessage()">Reply</div>
    <div class="context-menu-item" id="editMenuItem" onclick="editMessage()">Edit</div>
</div>

<!-- Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Ошибка</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="errorText">
          Текст ошибки
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>

{% endblock chat_with_client %}

{% block chat_extra_js %}
<script>
    let selected_client_id = {{ selected_client.id }};
    let contextMenuMessage = null;
    let editingMessage = null;
    let replyToMessage = null;

    const messagesContainer = document.getElementById('messagesContainer');

    document.addEventListener('DOMContentLoaded', function() {
        mark_read(selected_client_id);
        document.getElementById('messageInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    });

    document.addEventListener('hide.bs.modal', function (event) {
        if (document.activeElement) {
            document.activeElement.blur();
        }
    });

    document.addEventListener('click', function() {
        document.getElementById('contextMenu').classList.remove('show');
        contextMenuMessage = null;
    });

    {% for message in messages %}
    messagesContainer.appendChild(createMessageElement(
        {
            id: {{ message.id }},
            is_manager: {% if message.manager is not None %} true {% else %} false {% endif %},
            {% if message.reply_to is not None %}
            reply_to: {
                id: {{ message.reply_to.id }},
                text: '{{ message.reply_to.text }}'
            },
            {% else %}
            reply_to: null,
            {% endif %}
            text: '{{ message.text|escapejs }}',
            created: '{{ message.created|date:"d.m.Y" }} {{ message.created|time:"H:i" }}',
            edited: '{{ message.edited|date:"d.m.Y" }} {{ message.edited|time:"H:i" }}'.trim(),
            deleted: '{{ message.deleted|date:"d.m.Y" }} {{ message.deleted|time:"H:i" }}'.trim()
        }
    ));
    {% endfor %}

    scrollToBottom();

    {% include 'chat/chat_with_client.js' %}
</script>
{% endblock chat_extra_js %}
